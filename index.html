<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Production - Version Finale</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; position: sticky; top: 0; }
        input, select { width: 100%; padding: 5px; box-sizing: border-box; }
        button { padding: 8px 12px; margin: 5px; cursor: pointer; }
        .btn-add { background-color: #4CAF50; color: white; border: none; }
        .btn-edit { background-color: #FFC107; color: black; border: none; }
        .btn-delete { background-color: #f44336; color: white; border: none; }
        .btn-report { background-color: #2196F3; color: white; border: none; }
        .btn-save { background-color: #4CAF50; color: white; border: none; }
        .btn-cancel { background-color: #9E9E9E; color: white; border: none; }
        .form-group { margin-bottom: 15px; }
        .report-controls { margin: 20px 0; padding: 15px; background: #f9f9f9; }
        .hidden { display: none; }
        .efficiency-high { background-color: #d4edda; }
        .efficiency-medium { background-color: #fff3cd; }
        .efficiency-low { background-color: #f8d7da; }
        .editing { background-color: #e3f2fd !important; }
        .action-btns { white-space: nowrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gestion de Production - Suivi Complet</h1>
        
        <form id="productionForm">
            <div class="form-group">
                <label for="date">Date:</label>
                <input type="date" id="date" required>
            </div>
            
            <div class="form-group">
                <label for="salle">Salle de production:</label>
                <select id="salle" required>
                    <option value="">Sélectionnez une salle</option>
                    <option value="142">Salle 142</option>
                    <option value="158">Salle 158</option>
                    <option value="135">Salle 135</option>
                    <option value="118">Salle 118</option>
                    <option value="122">Salle 122</option>
                    <option value="132">Salle 132</option>
                    <option value="139">Salle 139</option>
                    <option value="A">Salle A</option>
                    <option value="B">Salle B</option>
                    <option value="C">Salle C</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="mo">Numéro de MO:</label>
                <input type="text" id="mo" required>
            </div>
            
            <div class="form-group">
                <label for="produit">Nom du produit:</label>
                <input type="text" id="produit" required>
            </div>
            
            <div class="form-group">
                <label for="quantiteDepart">Quantité de départ:</label>
                <input type="number" id="quantiteDepart" min="0" required>
            </div>
            
            <div class="form-group">
                <label for="quantiteTotale">Quantité totale à faire:</label>
                <input type="number" id="quantiteTotale" min="0" required>
            </div>
            
            <div class="form-group">
                <label for="quantiteFin">Quantité en fin de journée:</label>
                <input type="number" id="quantiteFin" min="0" required>
            </div>
            
            <div class="form-group">
                <label for="efficaciteTheorique">Quantité à produire à 100% (objectif idéal):</label>
                <input type="number" id="efficaciteTheorique" min="1" required>
                <small>Cette valeur sera utilisée comme référence pour calculer l'efficacité réelle</small>
            </div>
            
            <input type="hidden" id="editIndex" value="-1">
            
            <button type="button" class="btn-add" id="addButton" onclick="ajouterProduction()">Ajouter</button>
            <button type="button" class="btn-save hidden" id="saveButton" onclick="sauvegarderModification()">Enregistrer</button>
            <button type="button" class="btn-cancel hidden" id="cancelButton" onclick="annulerModification()">Annuler</button>
        </form>
        
        <div class="report-controls">
            <h2>Génération de Rapports</h2>
            <div>
                <label for="reportType">Type de rapport:</label>
                <select id="reportType">
                    <option value="journalier">Journalier</option>
                    <option value="hebdomadaire">Hebdomadaire</option>
                    <option value="mensuel">Mensuel</option>
                </select>
            </div>
            
            <div id="dateSelection">
                <div id="dailySelection">
                    <label for="reportDate">Date:</label>
                    <input type="date" id="reportDate">
                </div>
                
                <div id="weeklySelection" class="hidden">
                    <label for="reportWeek">Semaine:</label>
                    <input type="week" id="reportWeek">
                </div>
                
                <div id="monthlySelection" class="hidden">
                    <label for="reportMonth">Mois:</label>
                    <input type="month" id="reportMonth">
                </div>
            </div>
            
            <button type="button" class="btn-report" onclick="genererRapport()">Générer le Rapport PDF</button>
        </div>
        
        <div style="overflow-x: auto;">
            <table id="productionTable">
                <thead>
                    <tr>
                        <th>Actions</th>
                        <th>Date</th>
                        <th>Salle</th>
                        <th>MO</th>
                        <th>Produit</th>
                        <th>Départ</th>
                        <th>Total</th>
                        <th>Fin jour</th>
                        <th>Produit</th>
                        <th>Reste</th>
                        <th>Objectif 100%</th>
                        <th>Efficacité</th>
                    </tr>
                </thead>
                <tbody id="productionData">
                    <!-- Les données seront ajoutées ici -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Initialisation des données
        let productions = JSON.parse(localStorage.getItem('productions')) || [];
        let editIndex = -1;
        
        // Initialisation de jsPDF
        const { jsPDF } = window.jspdf;
        
        // Au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Afficher les données existantes
            afficherProductions();
            
            // Configurer la date du jour par défaut
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            document.getElementById('reportDate').value = today;
            
            // Gérer le changement de type de rapport
            document.getElementById('reportType').addEventListener('change', function() {
                document.getElementById('dailySelection').classList.add('hidden');
                document.getElementById('weeklySelection').classList.add('hidden');
                document.getElementById('monthlySelection').classList.add('hidden');
                
                if (this.value === 'journalier') {
                    document.getElementById('dailySelection').classList.remove('hidden');
                } else if (this.value === 'hebdomadaire') {
                    document.getElementById('weeklySelection').classList.remove('hidden');
                } else if (this.value === 'mensuel') {
                    document.getElementById('monthlySelection').classList.remove('hidden');
                }
            });
            
            // Calculer automatiquement l'objectif 100% basé sur la quantité totale
            document.getElementById('quantiteTotale').addEventListener('change', function() {
                const qteTotale = parseInt(this.value);
                if (!isNaN(qteTotale) && qteTotale > 0) {
                    document.getElementById('efficaciteTheorique').value = qteTotale;
                }
            });
        });
        
        function ajouterProduction() {
            // Récupérer les valeurs du formulaire
            const date = document.getElementById('date').value;
            const salle = document.getElementById('salle').value;
            const mo = document.getElementById('mo').value;
            const produit = document.getElementById('produit').value;
            const quantiteDepart = parseInt(document.getElementById('quantiteDepart').value);
            const quantiteTotale = parseInt(document.getElementById('quantiteTotale').value);
            const quantiteFin = parseInt(document.getElementById('quantiteFin').value);
            const efficaciteTheorique = parseInt(document.getElementById('efficaciteTheorique').value);
            
            // Validation
            if (!date || !salle || !mo || !produit || isNaN(quantiteDepart) || 
                isNaN(quantiteTotale) || isNaN(quantiteFin) || isNaN(efficaciteTheorique)) {
                alert('Veuillez remplir tous les champs correctement');
                return;
            }
            
            if (quantiteFin < quantiteDepart) {
                alert('La quantité en fin de journée ne peut pas être inférieure à la quantité de départ');
                return;
            }
            
            if (quantiteTotale < quantiteDepart) {
                alert('La quantité totale à faire ne peut pas être inférieure à la quantité de départ');
                return;
            }
            
            // Calculer les valeurs dérivées
            const quantiteProduite = quantiteFin - quantiteDepart;
            const reste = quantiteTotale - quantiteFin;
            
            // Calcul de l'efficacité réelle
            const efficaciteReelle = Math.min(
                Math.round((quantiteProduite / efficaciteTheorique) * 100),
                200
            );
            
            // Créer l'objet production
            const production = {
                date,
                salle,
                mo,
                produit,
                quantiteDepart,
                quantiteTotale,
                quantiteFin,
                quantiteProduite,
                reste,
                efficaciteTheorique,
                efficaciteReelle
            };
            
            // Ajouter à la liste
            productions.push(production);
            
            // Sauvegarder dans le localStorage
            localStorage.setItem('productions', JSON.stringify(productions));
            
            // Mettre à jour l'affichage
            afficherProductions();
            
            // Réinitialiser le formulaire
            document.getElementById('productionForm').reset();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            document.getElementById('editIndex').value = "-1";
            document.getElementById('addButton').classList.remove('hidden');
            document.getElementById('saveButton').classList.add('hidden');
            document.getElementById('cancelButton').classList.add('hidden');
        }
        
        function afficherProductions() {
            const tbody = document.getElementById('productionData');
            tbody.innerHTML = '';
            
            productions.forEach((prod, index) => {
                const row = document.createElement('tr');
                if (index === editIndex) {
                    row.classList.add('editing');
                }
                
                // Appliquer une classe CSS en fonction de l'efficacité
                if (prod.efficaciteReelle >= 90) {
                    row.classList.add('efficiency-high');
                } else if (prod.efficaciteReelle >= 70) {
                    row.classList.add('efficiency-medium');
                } else {
                    row.classList.add('efficiency-low');
                }
                
                row.innerHTML = `
                    <td class="action-btns">
                        <button class="btn-edit" onclick="modifierProduction(${index})">✏️</button>
                        <button class="btn-delete" onclick="supprimerProduction(${index})">🗑️</button>
                    </td>
                    <td>${prod.date}</td>
                    <td>Salle ${prod.salle}</td>
                    <td>${prod.mo}</td>
                    <td>${prod.produit}</td>
                    <td>${prod.quantiteDepart}</td>
                    <td>${prod.quantiteTotale}</td>
                    <td>${prod.quantiteFin}</td>
                    <td>${prod.quantiteProduite}</td>
                    <td>${prod.reste}</td>
                    <td>${prod.efficaciteTheorique}</td>
                    <td>${prod.efficaciteReelle}%</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function modifierProduction(index) {
            const prod = productions[index];
            editIndex = index;
            
            // Remplir le formulaire avec les données à modifier
            document.getElementById('date').value = prod.date;
            document.getElementById('salle').value = prod.salle;
            document.getElementById('mo').value = prod.mo;
            document.getElementById('produit').value = prod.produit;
            document.getElementById('quantiteDepart').value = prod.quantiteDepart;
            document.getElementById('quantiteTotale').value = prod.quantiteTotale;
            document.getElementById('quantiteFin').value = prod.quantiteFin;
            document.getElementById('efficaciteTheorique').value = prod.efficaciteTheorique;
            document.getElementById('editIndex').value = index;
            
            // Changer les boutons
            document.getElementById('addButton').classList.add('hidden');
            document.getElementById('saveButton').classList.remove('hidden');
            document.getElementById('cancelButton').classList.remove('hidden');
            
            // Mettre à jour l'affichage
            afficherProductions();
        }
        
        function sauvegarderModification() {
            const index = parseInt(document.getElementById('editIndex').value);
            if (index < 0 || index >= productions.length) return;
            
            // Récupérer les nouvelles valeurs
            const date = document.getElementById('date').value;
            const salle = document.getElementById('salle').value;
            const mo = document.getElementById('mo').value;
            const produit = document.getElementById('produit').value;
            const quantiteDepart = parseInt(document.getElementById('quantiteDepart').value);
            const quantiteTotale = parseInt(document.getElementById('quantiteTotale').value);
            const quantiteFin = parseInt(document.getElementById('quantiteFin').value);
            const efficaciteTheorique = parseInt(document.getElementById('efficaciteTheorique').value);
            
            // Validation
            if (!date || !salle || !mo || !produit || isNaN(quantiteDepart) || 
                isNaN(quantiteTotale) || isNaN(quantiteFin) || isNaN(efficaciteTheorique)) {
                alert('Veuillez remplir tous les champs correctement');
                return;
            }
            
            // Calculer les nouvelles valeurs
            const quantiteProduite = quantiteFin - quantiteDepart;
            const reste = quantiteTotale - quantiteFin;
            const efficaciteReelle = Math.min(
                Math.round((quantiteProduite / efficaciteTheorique) * 100),
                200
            );
            
            // Mettre à jour l'objet
            productions[index] = {
                date,
                salle,
                mo,
                produit,
                quantiteDepart,
                quantiteTotale,
                quantiteFin,
                quantiteProduite,
                reste,
                efficaciteTheorique,
                efficaciteReelle
            };
            
            // Sauvegarder
            localStorage.setItem('productions', JSON.stringify(productions));
            
            // Réinitialiser
            document.getElementById('productionForm').reset();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            editIndex = -1;
            document.getElementById('editIndex').value = "-1";
            document.getElementById('addButton').classList.remove('hidden');
            document.getElementById('saveButton').classList.add('hidden');
            document.getElementById('cancelButton').classList.add('hidden');
            
            // Mettre à jour l'affichage
            afficherProductions();
        }
        
        function annulerModification() {
            document.getElementById('productionForm').reset();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            editIndex = -1;
            document.getElementById('editIndex').value = "-1";
            document.getElementById('addButton').classList.remove('hidden');
            document.getElementById('saveButton').classList.add('hidden');
            document.getElementById('cancelButton').classList.add('hidden');
            afficherProductions();
        }
        
        function supprimerProduction(index) {
            if (confirm('Voulez-vous vraiment supprimer cette entrée?')) {
                productions.splice(index, 1);
                localStorage.setItem('productions', JSON.stringify(productions));
                afficherProductions();
            }
        }
        
       function genererRapport() {
            const reportType = document.getElementById('reportType').value;
            let filteredData = [];
            let titre = '';
            
            // [Le code de filtrage reste inchangé]
            
            if (filteredData.length === 0) {
                alert('Aucune donnée disponible pour cette période');
                return;
            }
            
            // Calculer les totaux et moyennes
            const totalDepart = filteredData.reduce((sum, p) => sum + p.quantiteDepart, 0);
            const totalAFaire = filteredData.reduce((sum, p) => sum + p.quantiteTotale, 0);
            const totalFin = filteredData.reduce((sum, p) => sum + p.quantiteFin, 0);
            const totalProduit = filteredData.reduce((sum, p) => sum + p.quantiteProduite, 0);
            const totalReste = filteredData.reduce((sum, p) => sum + p.reste, 0);
            const totalObjectif = filteredData.reduce((sum, p) => sum + p.efficaciteTheorique, 0);
            const moyenneEfficacite = Math.round(filteredData.reduce((sum, p) => sum + p.efficaciteReelle, 0) / filteredData.length);
            
            // Préparer les données pour le PDF - CORRECTION ICI
            const pdfData = filteredData.map(p => [
                p.date,
                `Salle ${p.salle}`,
                p.mo,
                p.produit,
                p.quantiteDepart.toString(),
                p.quantiteTotale.toString(),
                p.quantiteFin.toString(),
                p.quantiteProduite.toString(),
                p.reste.toString(),
                p.efficaciteTheorique.toString(),
                `${p.efficaciteReelle}%`  // On conserve explicitement le % ici
            ]);
            
            // Ajouter les totaux - CORRECTION ICI AUSSI
            pdfData.push([
                'TOTAUX/MOYENNES', '', '', '',
                totalDepart.toString(),
                totalAFaire.toString(),
                totalFin.toString(),
                totalProduit.toString(),
                totalReste.toString(),
                totalObjectif.toString(),
                `${moyenneEfficacite}%`  // Ajout du % pour la moyenne
            ]);

            // Créer le PDF
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm'
            });
            
            // Titre
            doc.setFontSize(14);
            doc.text(titre, 14, 15);
            doc.setFontSize(10);
            doc.text(`Généré le: ${new Date().toLocaleDateString()}`, 14, 22);
            
            // Tableau avec les corrections pour l'affichage des pourcentages
            doc.autoTable({
                startY: 25,
                head: [['Date', 'Salle', 'MO', 'Produit', 'Départ', 'Total', 'Fin jour', 'Produit', 'Reste', 'Objectif', 'Efficacité']],
                body: pdfData,
                styles: { 
                    fontSize: 7,
                    cellPadding: 2,
                    overflow: 'linebreak'
                },
                headStyles: { 
                    fillColor: [22, 160, 133],
                    fontSize: 8,
                    textColor: [255, 255, 255]
                },
                columnStyles: {
                    10: { cellWidth: 12 }  // Colonne efficacité un peu plus large
                },
                didDrawCell: function(data) {
                    // Colorer les cellules d'efficacité (colonne 10)
                    if (data.column.index === 10 && data.cell.raw) {
                        const effValue = parseInt(data.cell.raw);
                        if (!isNaN(effValue)) {
                            if (effValue >= 90) {
                                doc.setFillColor(212, 237, 218);
                            } else if (effValue >= 70) {
                                doc.setFillColor(255, 243, 205);
                            } else {
                                doc.setFillColor(248, 215, 218);
                            }
                            doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                        }
                    }
                },
                didDrawPage: function(data) {
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text('Système de Gestion de Production - © ' + new Date().getFullYear(), 
                            data.settings.margin.left, 
                            doc.internal.pageSize.height - 10);
                }
            });
            
            // Sauvegarder le PDF
            doc.save(`Rapport_Production_${reportType}.pdf`);
        }
        
        // Fonction utilitaire pour obtenir le numéro de semaine
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }
    </script>
</body>
</html>