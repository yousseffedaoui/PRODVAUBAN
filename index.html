<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi de Production Vauban - Mobile</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- API Google JavaScript -->
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        :root {
            --primary: #4285F4;
            --primary-dark: #3367D6;
            --secondary: #0F9D58;
            --secondary-dark: #0B8043;
            --warning: #F4B400;
            --danger: #DB4437;
            --light: #F8F9FA;
            --dark: #202124;
            --gray: #9AA0A6;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 10px;
            font-size: 14px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        
        h1 {
            font-size: 22px;
            margin-bottom: 8px;
        }
        
        .description {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .alert {
            background-color: #e8f0fe;
            color: var(--primary-dark);
            padding: 12px;
            margin: 15px;
            border-radius: 5px;
            border-left: 4px solid var(--primary);
            font-size: 13px;
        }
        
        .sync-section {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 15px;
            border-top: 4px solid var(--primary);
            width: 100%;
        }
        
        .card h2 {
            color: var(--primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            font-size: 18px;
        }
        
        .card p {
            margin-bottom: 12px;
            color: #666;
            font-size: 14px;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 16px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.3s;
            text-align: center;
            margin: 4px 0;
            width: 100%;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn:hover, .btn:focus {
            background-color: var(--primary-dark);
        }
        
        .btn-success {
            background-color: var(--secondary);
        }
        
        .btn-success:hover, .btn-success:focus {
            background-color: var(--secondary-dark);
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: #333;
        }
        
        .btn-warning:hover, .btn-warning:focus {
            background-color: #e6a700;
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover, .btn-danger:focus {
            background-color: #c1350c;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 13px;
        }
        
        .cloud-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .cloud-btn img {
            width: 20px;
            height: 20px;
        }
        
        .instructions {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid var(--primary);
            margin: 15px;
            font-size: 13px;
        }
        
        .instructions h3 {
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 16px;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .status {
            padding: 8px;
            margin: 8px 0;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .tabs {
            display: flex;
            margin: 0 10px;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .tabs::-webkit-scrollbar {
            display: none;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 4px;
            font-weight: bold;
            white-space: nowrap;
            font-size: 14px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .tab.active {
            background-color: white;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
        }
        
        .tab-content {
            display: none;
            padding: 15px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px; /* EmpÃªche le zoom sur iOS */
            -webkit-appearance: none;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }
        
        /* Table responsive */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 15px;
            position: relative;
            max-width: 100%;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 13px;
        }
        
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .filters {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            width: 100%;
        }
        
        .hidden {
            display: none;
        }
        
        .actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Menu hamburger pour mobile */
        .mobile-menu-btn {
            display: none;
            flex-direction: column;
            justify-content: space-around;
            width: 30px;
            height: 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            position: absolute;
            right: 15px;
            top: 15px;
        }
        
        .mobile-menu-btn span {
            width: 100%;
            height: 3px;
            background: white;
            border-radius: 2px;
        }
        
        /* Modal pour les actions sur mobile */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: hidden;
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: relative;
            animation: modalopen 0.3s;
        }
        
        @keyframes modalopen {
            from {opacity: 0; transform: translateY(-20px);}
            to {opacity: 1; transform: translateY(0);}
        }
        
        .close-modal {
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            background: none;
            border: none;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: black;
        }
        
        /* Media queries pour mobile */
        @media (max-width: 768px) {
            body {
                padding: 5px;
                font-size: 13px;
            }
            
            header {
                padding: 12px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 13px;
            }
            
            .tab-content {
                padding: 12px;
            }
            
            .card {
                padding: 12px;
            }
            
            .btn {
                padding: 14px 16px; /* Plus grand pour le tactile */
            }
            
            .mobile-menu-btn {
                display: flex;
            }
            
            .tabs {
                flex-direction: column;
                display: none;
                position: absolute;
                top: 60px;
                right: 10px;
                background: white;
                border-radius: 5px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10;
                width: 200px;
            }
            
            .tabs.active {
                display: flex;
            }
            
            .tab {
                border-radius: 0;
                margin-right: 0;
                border: none;
                border-bottom: 1px solid #eee;
            }
            
            .tab:last-child {
                border-bottom: none;
            }
            
            /* AmÃ©lioration de l'affichage du tableau sur mobile */
            .table-container {
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            
            th, td {
                padding: 8px;
                font-size: 12px;
            }
            
            /* Formulaire optimisÃ© pour mobile */
            input, select {
                padding: 14px;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 18px;
            }
            
            .tab {
                padding: 8px 12px;
            }
            
            .alert, .instructions {
                margin: 10px;
                padding: 10px;
            }
            
            .btn {
                font-size: 14px;
            }
        }
        
        /* Styles pour les Ã©crans trÃ¨s petits */
        @media (max-width: 360px) {
            th, td {
                padding: 6px;
                font-size: 11px;
            }
            
            .btn {
                padding: 12px 10px;
                font-size: 13px;
            }
        }
        
        /* AmÃ©lioration de l'expÃ©rience tactile */
        @media (hover: none) {
            .btn:hover {
                background-color: var(--primary);
            }
            
            .btn-success:hover {
                background-color: var(--secondary);
            }
            
            .btn-warning:hover {
                background-color: var(--warning);
            }
            
            .btn-danger:hover {
                background-color: var(--danger);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="mobile-menu-btn" id="mobile-menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <h1>Suivi de Production Vauban</h1>
            <p class="description">Application de suivi de production avec synchronisation Google Drive</p>
        </header>
        
        <div class="alert">
            <strong>Synchronisation Google Drive :</strong> Connectez-vous pour sauvegarder et synchroniser vos donnÃ©es sur tous vos postes.
        </div>
        
        <div class="tabs" id="tabs-container">
            <div class="tab active" data-tab="saisie">Saisie</div>
            <div class="tab" data-tab="visualisation">Visualisation</div>
            <div class="tab" data-tab="synchronisation">Synchronisation</div>
        </div>
        
        <div class="tab-content active" id="saisie">
            <form id="productionForm">
                <div class="form-group">
                    <label for="date">Date:</label>
                    <input type="date" id="date" required>
                </div>
                
                <div class="form-group">
                    <label for="salle">NumÃ©ro de salle:</label>
                    <select id="salle" required>
                        <option value="">SÃ©lectionnez une salle</option>
                        <option value="142">142</option>
                        <option value="158">158</option>
                        <option value="135">135</option>
                        <option value="122">122</option>
                        <option value="118">118</option>
                        <option value="132">132</option>
                        <option value="139">139</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="mo">NumÃ©ro MO:</label>
                    <input type="text" id="mo" required>
                </div>
                
                <div class="form-group">
                    <label for="produit">Nom du produit:</label>
                    <input type="text" id="produit" required>
                </div>
                
                <div class="form-group">
                    <label for="quantiteDepart">QuantitÃ© dÃ©part:</label>
                    <input type="number" id="quantiteDepart" required>
                </div>
                
                <div class="form-group">
                    <label for="quantiteTotale">QuantitÃ© totale Ã  produire:</label>
                    <input type="number" id="quantiteTotale" required>
                </div>
                
                <div class="form-group">
                    <label for="quantiteObjectif">QuantitÃ© objectif (100% par jour):</label>
                    <input type="number" id="quantiteObjectif" required>
                </div>
                
                <div class="form-group hidden" id="finJourneeGroup">
                    <label for="quantiteFinJournee">QuantitÃ© fin de journÃ©e:</label>
                    <input type="number" id="quantiteFinJournee">
                </div>
                
                <div class="actions">
                    <button type="submit" class="btn btn-success">Ajouter EntrÃ©e</button>
                    <button type="button" id="showFinJournee" class="btn">Fin de journÃ©e</button>
                </div>
            </form>
        </div>
        
        <div class="tab-content" id="visualisation">
            <div class="filters">
                <div class="filter-group">
                    <label for="filterDate">Filtrer par date:</label>
                    <input type="date" id="filterDate">
                </div>
                <div class="filter-group">
                    <label for="filterSalle">Filtrer par salle:</label>
                    <select id="filterSalle">
                        <option value="">Toutes les salles</option>
                        <option value="142">142</option>
                        <option value="158">158</option>
                        <option value="135">135</option>
                        <option value="122">122</option>
                        <option value="118">118</option>
                        <option value="132">132</option>
                        <option value="139">139</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterProduit">Filtrer par produit:</label>
                    <input type="text" id="filterProduit" placeholder="Nom du produit">
                </div>
            </div>
            
            <div class="table-container">
                <table id="productionTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Salle</th>
                            <th>MO</th>
                            <th>Produit</th>
                            <th>DÃ©part</th>
                            <th>Totale</th>
                            <th>Restante</th>
                            <th>Fin journÃ©e</th>
                            <th>Produite</th>
                            <th>Objectif</th>
                            <th>EfficacitÃ©</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Les donnÃ©es seront ajoutÃ©es ici dynamiquement -->
                    </tbody>
                </table>
            </div>
            
            <div class="actions">
                <button type="button" id="generateWeekly" class="btn btn-warning">GÃ©nÃ©rer PDF Hebdomadaire</button>
                <button type="button" id="generateMonthly" class="btn btn-warning">GÃ©nÃ©rer PDF Mensuel</button>
                <button type="button" id="clearData" class="btn btn-danger">Effacer toutes les donnÃ©es</button>
            </div>
        </div>
        
        <div class="tab-content" id="synchronisation">
            <div class="sync-section">
                <div class="card">
                    <h2>Synchronisation avec Google Drive</h2>
                    <p>Connectez-vous Ã  votre compte Google pour sauvegarder et synchroniser vos donnÃ©es.</p>
                    <button id="google-drive-btn" class="btn cloud-btn">
                        <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7.71 3.29L6.29 4.71L9.17 7.59L9.59 8L11 6.59L8 3.59L7.71 3.29zM12 6.59L15 3.59L15.29 3.29L16.71 4.71L13.83 7.59L13.41 8L12 6.59zM21 9.59L18 6.59L17.71 6.29L16.29 7.71L19.17 10.59L19.59 11L21 9.59zM4 12.59L3.59 13L2.29 14.29L1.59 15L2.29 15.71L4.71 18.29L5.41 19L6.71 17.71L7.41 17L6.71 16.29L4 13.59L4 12.59zM19 12.59L19.59 13L20.29 13.71L21.41 12.59L20.71 11.88L20 12.59L19 12.59zM12 18.59L13 17.59L13.71 18.29L14.41 19L15.71 17.71L16.41 17L15.71 16.29L12 12.59L11.41 12L10.59 12.82L10 13.41L12 15.41L12 18.59zM9 17.59L8 18.59L7.29 17.88L6.59 17.17L5.29 18.47L4.59 19.17L5.29 19.88L6 20.59L6.71 19.88L8 18.59L9 17.59z"/>
                        </svg>
                        Se connecter Ã  Google Drive
                    </button>
                    <div id="google-status"></div>
                    <div id="drive-actions" class="hidden">
                        <button id="save-to-drive" class="btn btn-success">Sauvegarder sur Drive</button>
                        <button id="load-from-drive" class="btn">Charger depuis Drive</button>
                    </div>
                </div>
                
                <div class="card">
                    <h2>Export/Import manuel</h2>
                    <p>Exportez ou importez manuellement vos donnÃ©es si vous prÃ©fÃ©rez ne pas utiliser Google Drive.</p>
                    <div class="form-group">
                        <label for="import-file">SÃ©lectionner le fichier JSON</label>
                        <input type="file" id="import-file" accept=".json">
                    </div>
                    <button id="export-btn" class="btn btn-success">Exporter les donnÃ©es</button>
                    <button id="import-btn" class="btn">Importer les donnÃ©es</button>
                    <div id="file-status"></div>
                </div>
            </div>
            
            <div class="instructions">
                <h3>Comment synchroniser vos donnÃ©es avec Google Drive</h3>
                <ol>
                    <li>Cliquez sur "Se connecter Ã  Google Drive" et autorisez l'application</li>
                    <li>Une fois connectÃ©, cliquez sur "Sauvegarder sur Drive" pour enregistrer vos donnÃ©es</li>
                    <li>Sur un autre poste, connectez-vous au mÃªme compte Google et cliquez sur "Charger depuis Drive"</li>
                    <li>Vos donnÃ©es seront synchronisÃ©es sur tous vos postes</li>
                </ol>
                <p><strong>Remarque :</strong> Vous devez configurer les identifiants OAuth dans la Google Cloud Console pour que cette fonctionnalitÃ© fonctionne complÃ¨tement.</p>
            </div>
        </div>
    </div>

    <!-- Modal pour les actions sur mobile -->
    <div id="actionModal" class="modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 id="modal-title">Action</h2>
            <div id="modal-body">
                <!-- Le contenu sera insÃ©rÃ© ici dynamiquement -->
            </div>
        </div>
    </div>

    <script>
        // Initialiser jsPDF
        const { jsPDF } = window.jspdf;
        
        // Stockage des donnÃ©es
        let productionData = JSON.parse(localStorage.getItem('productionData')) || [];
        let isGoogleSignedIn = false;
        let googleAccessToken = null;
        let driveFileId = null;
        
        // ÃlÃ©ments du DOM
        const form = document.getElementById('productionForm');
        const tableBody = document.getElementById('tableBody');
        const showFinJourneeBtn = document.getElementById('showFinJournee');
        const finJourneeGroup = document.getElementById('finJourneeGroup');
        const generateWeeklyBtn = document.getElementById('generateWeekly');
        const generateMonthlyBtn = document.getElementById('generateMonthly');
        const clearDataBtn = document.getElementById('clearData');
        const filterDate = document.getElementById('filterDate');
        const filterSalle = document.getElementById('filterSalle');
        const filterProduit = document.getElementById('filterProduit');
        const googleDriveBtn = document.getElementById('google-drive-btn');
        const saveToDriveBtn = document.getElementById('save-to-drive');
        const loadFromDriveBtn = document.getElementById('load-from-drive');
        const driveActions = document.getElementById('drive-actions');
        const googleStatus = document.getElementById('google-status');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const importFile = document.getElementById('import-file');
        const fileStatus = document.getElementById('file-status');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const mobileMenuBtn = document.getElementById('mobile-menu');
        const tabsContainer = document.getElementById('tabs-container');
        const modal = document.getElementById('actionModal');
        const closeModalBtn = document.querySelector('.close-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        
        // DÃ©finir la date du jour par dÃ©faut
        document.getElementById('date').valueAsDate = new Date();
        
        // Gestion du menu mobile
        mobileMenuBtn.addEventListener('click', () => {
            tabsContainer.classList.toggle('active');
        });
        
        // Fermer le menu quand on clique ailleurs
        document.addEventListener('click', (e) => {
            if (!tabsContainer.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                tabsContainer.classList.remove('active');
            }
        });
        
        // Gestion de la modal
        closeModalBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // Fonction pour afficher une modal
        function showModal(title, content) {
            modalTitle.textContent = title;
            modalBody.innerHTML = content;
            modal.style.display = 'block';
        }
        
        // Gestion des onglets
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // DÃ©sactiver tous les onglets et contenus
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                
                // Activer l'onglet et le contenu correspondant
                tab.classList.add('active');
                document.getElementById(tabId).classList.add('active');
                
                // Fermer le menu mobile aprÃ¨s sÃ©lection
                tabsContainer.classList.remove('active');
                
                // Si on passe Ã  l'onglet visualisation, mettre Ã  jour le tableau
                if (tabId === 'visualisation') {
                    renderTable();
                }
            });
        });
        
        // Afficher/masquer le champ fin de journÃ©e
        showFinJourneeBtn.addEventListener('click', () => {
            finJourneeGroup.classList.toggle('hidden');
            showFinJourneeBtn.textContent = finJourneeGroup.classList.contains('hidden') 
                ? 'Fin de journÃ©e' 
                : 'Masquer fin de journÃ©e';
        });
        
        // Soumission du formulaire
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const date = document.getElementById('date').value;
            const salle = document.getElementById('salle').value;
            const mo = document.getElementById('mo').value;
            const produit = document.getElementById('produit').value;
            const quantiteDepart = parseFloat(document.getElementById('quantiteDepart').value);
            const quantiteTotale = parseFloat(document.getElementById('quantiteTotale').value);
            const quantiteObjectif = parseFloat(document.getElementById('quantiteObjectif').value);
            const quantiteFinJournee = document.getElementById('quantiteFinJournee').value 
                ? parseFloat(document.getElementById('quantiteFinJournee').value) 
                : null;
            
            // Calculer la quantitÃ© restante, produite et l'efficacitÃ©
            const quantiteRestante = quantiteTotale - quantiteDepart;
            let quantiteProduite = null;
            let efficacite = null;
            
            if (quantiteFinJournee !== null) {
                quantiteProduite = quantiteFinJournee - quantiteDepart;
                efficacite = ((quantiteProduite) / quantiteObjectif * 100).toFixed(2) + '%';
            }
            
            // Ajouter les donnÃ©es
            const entry = {
                id: Date.now(),
                date,
                salle,
                mo,
                produit,
                quantiteDepart,
                quantiteTotale,
                quantiteRestante,
                quantiteFinJournee,
                quantiteProduite,
                quantiteObjectif,
                efficacite
            };
            
            productionData.push(entry);
            saveData();
            renderTable();
            form.reset();
            
            // RÃ©initialiser la date
            document.getElementById('date').valueAsDate = new Date();
            
            if (!finJourneeGroup.classList.contains('hidden')) {
                finJourneeGroup.classList.add('hidden');
                showFinJourneeBtn.textContent = 'Fin de journÃ©e';
            }
            
            // Afficher un message de confirmation
            showModal('SuccÃ¨s', '<div class="status success">EntrÃ©e enregistrÃ©e avec succÃ¨s!</div>');
        });
        
        // Rendre le tableau
        function renderTable(filteredData = null) {
            const dataToRender = filteredData || productionData;
            
            tableBody.innerHTML = '';
            
            if (dataToRender.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="12" style="text-align: center;">Aucune donnÃ©e disponible</td>';
                tableBody.appendChild(row);
                return;
            }
            
            // Trier les donnÃ©es par date (la plus rÃ©cente en premier)
            const sortedData = [...dataToRender].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedData.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(entry.date)}</td>
                    <td>${entry.salle}</td>
                    <td>${entry.mo}</td>
                    <td>${entry.produit}</td>
                    <td>${entry.quantiteDepart}</td>
                    <td>${entry.quantiteTotale}</td>
                    <td>${entry.quantiteRestante}</td>
                    <td>${entry.quantiteFinJournee !== null ? entry.quantiteFinJournee : '-'}</td>
                    <td>${entry.quantiteProduite !== null ? entry.quantiteProduite : '-'}</td>
                    <td>${entry.quantiteObjectif}</td>
                    <td>${entry.efficacite || '-'}</td>
                    <td>
                        <button onclick="editEntry(${entry.id})" class="btn btn-sm">Modifier</button>
                        <button onclick="deleteEntry(${entry.id})" class="btn btn-sm btn-danger">Supprimer</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Formater la date
        function formatDate(dateString) {
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return new Date(dateString).toLocaleDateString('fr-FR', options);
        }
        
        // Sauvegarder les donnÃ©es
        function saveData() {
            localStorage.setItem('productionData', JSON.stringify(productionData));
        }
        
        // Supprimer une entrÃ©e
        window.deleteEntry = function(id) {
            showModal('Confirmation', `
                <p>Ãtes-vous sÃ»r de vouloir supprimer cette entrÃ©e ?</p>
                <div class="actions">
                    <button class="btn btn-danger" onclick="confirmDelete(${id})">Oui, supprimer</button>
                    <button class="btn" onclick="modal.style.display='none'">Annuler</button>
                </div>
            `);
        };
        
        window.confirmDelete = function(id) {
            productionData = productionData.filter(entry => entry.id !== id);
            saveData();
            renderTable();
            modal.style.display = 'none';
            showModal('SuccÃ¨s', '<div class="status success">EntrÃ©e supprimÃ©e avec succÃ¨s!</div>');
        };
        
        // Modifier une entrÃ©e
        window.editEntry = function(id) {
            const entry = productionData.find(item => item.id === id);
            if (!entry) return;
            
            document.getElementById('date').value = entry.date;
            document.getElementById('salle').value = entry.salle;
            document.getElementById('mo').value = entry.mo;
            document.getElementById('produit').value = entry.produit;
            document.getElementById('quantiteDepart').value = entry.quantiteDepart;
            document.getElementById('quantiteTotale').value = entry.quantiteTotale;
            document.getElementById('quantiteObjectif').value = entry.quantiteObjectif;
            
            if (entry.quantiteFinJournee !== null) {
                document.getElementById('quantiteFinJournee').value = entry.quantiteFinJournee;
                finJourneeGroup.classList.remove('hidden');
                showFinJourneeBtn.textContent = 'Masquer fin de journÃ©e';
            }
            
            // Supprimer l'ancienne entrÃ©e
            productionData = productionData.filter(item => item.id !== id);
            saveData();
            
            // Basculer vers l'onglet de saisie
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));
            document.querySelector('[data-tab="saisie"]').classList.add('active');
            document.getElementById('saisie').classList.add('active');
            
            showModal('Modification', '<div class="status success">Vous pouvez maintenant modifier l\'entrÃ©e sÃ©lectionnÃ©e.</div>');
        };
        
        // GÃ©nÃ©rer PDF hebdomadaire
        generateWeeklyBtn.addEventListener('click', () => {
            generatePDF('weekly');
        });
        
        // GÃ©nÃ©rer PDF mensuel
        generateMonthlyBtn.addEventListener('click', () => {
            generatePDF('monthly');
        });
        
        // Fonction pour gÃ©nÃ©rer PDF
        function generatePDF(type) {
            if (productionData.length === 0) {
                showModal('Erreur', '<div class="status error">Aucune donnÃ©e Ã  exporter!</div>');
                return;
            }
            
            const doc = new jsPDF();
            const title = type === 'weekly' ? 'Rapport Hebdomadaire de Production' : 'Rapport Mensuel de Production';
            
            // PrÃ©parer les donnÃ©es pour le PDF
            const pdfData = productionData.map(entry => [
                formatDate(entry.date),
                entry.salle,
                entry.mo,
                entry.produit,
                entry.quantiteDepart,
                entry.quantiteTotale,
                entry.quantiteRestante,
                entry.quantiteFinJournee !== null ? entry.quantiteFinJournee : '-',
                entry.quantiteProduite !== null ? entry.quantiteProduite : '-',
                entry.quantiteObjectif,
                entry.efficacite || '-'
            ]);
            
            // Ajouter le titre
            doc.text(title, 14, 15);
            
            // Ajouter le tableau
            doc.autoTable({
                head: [
                    ['Date', 'Salle', 'MO', 'Produit', 'DÃ©part', 'Totale', 'Restante', 'Fin journÃ©e', 'Produite', 'Objectif', 'EfficacitÃ©']
                ],
                body: pdfData,
                startY: 20,
                styles: {
                    fontSize: 8,
                    cellWidth: 'wrap'
                },
                headStyles: {
                    fillColor: [64, 64, 64]
                }
            });
            
            // Sauvegarder le PDF
            doc.save(`${title.toLowerCase().replace(/ /g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`);
            
            showModal('SuccÃ¨s', '<div class="status success">PDF gÃ©nÃ©rÃ© avec succÃ¨s!</div>');
        }
        
        // Effacer toutes les donnÃ©es
        clearDataBtn.addEventListener('click', () => {
            showModal('Confirmation', `
                <p>Ãtes-vous sÃ»r de vouloir effacer toutes les donnÃ©es ? Cette action est irrÃ©versible.</p>
                <div class="actions">
                    <button class="btn btn-danger" onclick="confirmClear()">Oui, tout effacer</button>
                    <button class="btn" onclick="modal.style.display='none'">Annuler</button>
                </div>
            `);
        });
        
        window.confirmClear = function() {
            productionData = [];
            saveData();
            renderTable();
            modal.style.display = 'none';
            showModal('SuccÃ¨s', '<div class="status success">Toutes les donnÃ©es ont Ã©tÃ© effacÃ©es!</div>');
        };
        
        // Filtrer les donnÃ©es
        filterDate.addEventListener('change', applyFilters);
        filterSalle.addEventListener('change', applyFilters);
        filterProduit.addEventListener('input', applyFilters);
        
        function applyFilters() {
            let filteredData = [...productionData];
            
            // Filtrer par date
            if (filterDate.value) {
                filteredData = filteredData.filter(entry => entry.date === filterDate.value);
            }
            
            // Filtrer par salle
            if (filterSalle.value) {
                filteredData = filteredData.filter(entry => entry.salle === filterSalle.value);
            }
            
            // Filtrer par produit
            if (filterProduit.value) {
                const searchTerm = filterProduit.value.toLowerCase();
                filteredData = filteredData.filter(entry => 
                    entry.produit.toLowerCase().includes(searchTerm)
                );
            }
            
            renderTable(filteredData);
        }
        
        // Initialisation de l'API Google Drive
        function initGoogleDrive() {
            gapi.load('client:auth2', () => {
                gapi.client.init({
                    apiKey: 'VOTRE_CLE_API',
                    clientId: 'VOTRE_ID_CLIENT',
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                    scope: 'https://www.googleapis.com/auth/drive.file'
                }).then(() => {
                    // Ãcouter les changements de connexion
                    gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                    // Mettre Ã  jour l'Ã©tat de connexion
                    updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                }).catch(error => {
                    console.error('Erreur initialisation API Google:', error);
                    googleStatus.innerHTML = `<div class="status error">Erreur d'initialisation: ${error.result?.error?.message || error.message}</div>`;
                });
            });
        }
        
        // Mettre Ã  jour l'Ã©tat de connexion
        function updateSigninStatus(isSignedIn) {
            isGoogleSignedIn = isSignedIn;
            if (isSignedIn) {
                googleAccessToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
                googleDriveBtn.textContent = 'DÃ©connexion de Google Drive';
                driveActions.classList.remove('hidden');
                googleStatus.innerHTML = '<div class="status success">ConnectÃ© Ã  Google Drive</div>';
            } else {
                googleAccessToken = null;
                googleDriveBtn.textContent = 'Se connecter Ã  Google Drive';
                driveActions.classList.add('hidden');
                googleStatus.innerHTML = '<div class="status">DÃ©connectÃ© de Google Drive</div>';
            }
        }
        
        // Connexion/DÃ©connexion Google Drive
        googleDriveBtn.addEventListener('click', () => {
            if (isGoogleSignedIn) {
                gapi.auth2.getAuthInstance().signOut();
            } else {
                gapi.auth2.getAuthInstance().signIn();
            }
        });
        
        // Sauvegarder sur Google Drive
        saveToDriveBtn.addEventListener('click', () => {
            if (!isGoogleSignedIn) {
                showModal('Erreur', '<div class="status error">Veuillez vous connecter Ã  Google Drive d\'abord</div>');
                return;
            }
            
            googleStatus.innerHTML = '<div class="status">Sauvegarde en cours...</div>';
            
            const fileContent = JSON.stringify(productionData, null, 2);
            const file = new Blob([fileContent], {type: 'application/json'});
            const metadata = {
                name: `production_data_${new Date().toISOString().slice(0,10)}.json`,
                mimeType: 'application/json'
            };
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', file);
            
            // Si un fichier existe dÃ©jÃ , on le met Ã  jour, sinon on en crÃ©e un nouveau
            const url = driveFileId ? 
                `https://www.googleapis.com/upload/drive/v3/files/${driveFileId}` : 
                'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
            const method = driveFileId ? 'PATCH' : 'POST';
            
            fetch(url, {
                method: method,
                headers: new Headers({'Authorization': 'Bearer ' + googleAccessToken}),
                body: form
            }).then(response => response.json())
            .then(data => {
                driveFileId = data.id;
                googleStatus.innerHTML = '<div class="status success">DonnÃ©es sauvegardÃ©es sur Google Drive avec succÃ¨s!</div>';
                showModal('SuccÃ¨s', '<div class="status success">DonnÃ©es sauvegardÃ©es sur Google Drive avec succÃ¨s!</div>');
            }).catch(error => {
                console.error('Erreur sauvegarde Drive:', error);
                googleStatus.innerHTML = `<div class="status error">Erreur lors de la sauvegarde: ${error.message}</div>`;
                showModal('Erreur', `<div class="status error">Erreur lors de la sauvegarde: ${error.message}</div>`);
            });
        });
        
        // Charger depuis Google Drive
        loadFromDriveBtn.addEventListener('click', () => {
            if (!isGoogleSignedIn) {
                showModal('Erreur', '<div class="status error">Veuillez vous connecter Ã  Google Drive d\'abord</div>');
                return;
            }
            
            googleStatus.innerHTML = '<div class="status">Chargement en cours...</div>';
            
            // Rechercher le fichier de donnÃ©es
            gapi.client.drive.files.list({
                q: "name contains 'production_data_' and mimeType='application/json'",
                fields: 'files(id, name)',
                orderBy: 'createdTime desc'
            }).then(response => {
                const files = response.result.files;
                if (files && files.length > 0) {
                    driveFileId = files[0].id;
                    // Charger le contenu du fichier
                    return gapi.client.drive.files.get({
                        fileId: driveFileId,
                        alt: 'media'
                    });
                } else {
                    throw new Error('Aucun fichier de donnÃ©es trouvÃ© sur Google Drive');
                }
            }).then(response => {
                productionData = response.result;
                saveData();
                renderTable();
                googleStatus.innerHTML = '<div class="status success">DonnÃ©es chargÃ©es depuis Google Drive avec succÃ¨s!</div>';
                showModal('SuccÃ¨s', '<div class="status success">DonnÃ©es chargÃ©es depuis Google Drive avec succÃ¨s!</div>');
            }).catch(error => {
                console.error('Erreur chargement Drive:', error);
                googleStatus.innerHTML = `<div class="status error">Erreur lors du chargement: ${error.result?.error?.message || error.message}</div>`;
                showModal('Erreur', `<div class="status error">Erreur lors du chargement: ${error.result?.error?.message || error.message}</div>`);
            });
        });
        
        // Exporter les donnÃ©es vers un fichier
        exportBtn.addEventListener('click', () => {
            if (productionData.length === 0) {
                fileStatus.innerHTML = '<div class="status error">Aucune donnÃ©e Ã  exporter!</div>';
                showModal('Erreur', '<div class="status error">Aucune donnÃ©e Ã  exporter!</div>');
                return;
            }
            
            const dataStr = JSON.stringify(productionData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `production_data_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            fileStatus.innerHTML = '<div class="status success">DonnÃ©es exportÃ©es avec succÃ¨s!</div>';
            showModal('SuccÃ¨s', '<div class="status success">DonnÃ©es exportÃ©es avec succÃ¨s!</div>');
        });
        
        // Importer les donnÃ©es depuis un fichier
        importBtn.addEventListener('click', () => {
            const file = importFile.files[0];
            if (!file) {
                fileStatus.innerHTML = '<div class="status error">Veuillez sÃ©lectionner un fichier</div>';
                showModal('Erreur', '<div class="status error">Veuillez sÃ©lectionner un fichier</div>');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (Array.isArray(importedData)) {
                        showModal('Importation', `
                            <p>Comment souhaitez-vous importer les donnÃ©es ?</p>
                            <div class="actions">
                                <button class="btn btn-danger" onclick="replaceData(${JSON.stringify(importedData).replace(/"/g, '&quot;')})">Remplacer les donnÃ©es existantes</button>
                                <button class="btn btn-success" onclick="mergeData(${JSON.stringify(importedData).replace(/"/g, '&quot;')})">Fusionner avec les donnÃ©es existantes</button>
                                <button class="btn" onclick="modal.style.display='none'">Annuler</button>
                            </div>
                        `);
                    } else {
                        fileStatus.innerHTML = '<div class="status error">Format de fichier invalide</div>';
                        showModal('Erreur', '<div class="status error">Format de fichier invalide</div>');
                    }
                } catch (error) {
                    fileStatus.innerHTML = `<div class="status error">Erreur lors de l'importation: ${error.message}</div>`;
                    showModal('Erreur', `<div class="status error">Erreur lors de l'importation: ${error.message}</div>`);
                }
            };
            reader.readAsText(file);
        });
        
        window.replaceData = function(importedData) {
            productionData = importedData;
            saveData();
            renderTable();
            modal.style.display = 'none';
            fileStatus.innerHTML = '<div class="status success">DonnÃ©es importÃ©es avec succÃ¨s!</div>';
            showModal('SuccÃ¨s', '<div class="status success">DonnÃ©es importÃ©es avec succÃ¨s!</div>');
        };
        
        window.mergeData = function(importedData) {
            productionData = [...productionData, ...importedData];
            
            // Ãliminer les doublons basÃ©s sur l'ID
            productionData = productionData.filter((entry, index, self) =>
                index === self.findIndex(e => e.id === entry.id)
            );
            
            saveData();
            renderTable();
            modal.style.display = 'none';
            fileStatus.innerHTML = '<div class="status success">DonnÃ©es fusionnÃ©es avec succÃ¨s!</div>';
            showModal('SuccÃ¨s', '<div class="status success">DonnÃ©es fusionnÃ©es avec succÃ¨s!</div>');
        };
        
        // Initialiser l'API Google au chargement de la page
        window.onload = function() {
            // Initialiser le tableau
            renderTable();
            
            // Initialiser Google Drive API
            initGoogleDrive();
        };
    </script>
</body>
</html>

